#!/usr/bin/env bash
set -e

INPUT0="${INPUT0:-/etc/mosaic/1920x1080-black.png}"
INPUT1="${INPUT1:-/etc/mosaic/1920x1080.png}"
INPUT2="${INPUT2:-/etc/mosaic/1920x1080.png}"
INPUT3="${INPUT3:-/etc/mosaic/1920x1080.png}"
INPUT4="${INPUT4:-/etc/mosaic/1920x1080.png}"
INPUT5="${INPUT5:-/etc/mosaic/1920x1080.png}"
INPUT6="${INPUT6:-/etc/mosaic/1920x1080.png}"
CONTAINER="${CONTAINER:-mpegts}"
OUTPUT="${OUTPUT:-udp://224.0.51.1:1234?pkt_size=188}"
BITRATE="${BITRATE:-8M}"

ffmpeg=$(command -v ffmpeg)
regex_url='(https?|ftp|file)://[-[:alnum:]\+&@#/%?=~_|!:,.;]*[-[:alnum:]\+&@#/%=~_|]'

INPUT_RECONNECT0=""
INPUT_RECONNECT1=""
INPUT_RECONNECT2=""
INPUT_RECONNECT3=""
INPUT_RECONNECT4=""
INPUT_RECONNECT5=""
INPUT_RECONNECT6=""

[[ $INPUT0 =~ $regex_url ]] && INPUT_RECONNECT0="-reconnect_on_network_error 1 -reconnect_on_http_error 1 -reconnect_streamed 1 -reconnect_delay_max 2000"
[[ $INPUT1 =~ $regex_url ]] && INPUT_RECONNECT1="-reconnect_on_network_error 1 -reconnect_on_http_error 1 -reconnect_streamed 1 -reconnect_delay_max 2000"
[[ $INPUT2 =~ $regex_url ]] && INPUT_RECONNECT2="-reconnect_on_network_error 1 -reconnect_on_http_error 1 -reconnect_streamed 1 -reconnect_delay_max 2000"
[[ $INPUT3 =~ $regex_url ]] && INPUT_RECONNECT3="-reconnect_on_network_error 1 -reconnect_on_http_error 1 -reconnect_streamed 1 -reconnect_delay_max 2000"
[[ $INPUT4 =~ $regex_url ]] && INPUT_RECONNECT4="-reconnect_on_network_error 1 -reconnect_on_http_error 1 -reconnect_streamed 1 -reconnect_delay_max 2000"
[[ $INPUT5 =~ $regex_url ]] && INPUT_RECONNECT5="-reconnect_on_network_error 1 -reconnect_on_http_error 1 -reconnect_streamed 1 -reconnect_delay_max 2000"
[[ $INPUT6 =~ $regex_url ]] && INPUT_RECONNECT6="-reconnect_on_network_error 1 -reconnect_on_http_error 1 -reconnect_streamed 1 -reconnect_delay_max 2000"

$ffmpeg -nostats -y -hide_banner -loglevel warning \
	-nostats -y -hide_banner -loglevel warning \
	${INPUT_RECONNECT0} -thread_queue_size 512 -hwaccel cuda -hwaccel_output_format nv12 -i $INPUT0 \
	${INPUT_RECONNECT1} -thread_queue_size 4096 -hwaccel cuda -hwaccel_output_format nv12 -i $INPUT1 \
	${INPUT_RECONNECT2} -thread_queue_size 4096 -hwaccel cuda -hwaccel_output_format nv12 -i $INPUT2 \
	${INPUT_RECONNECT3} -thread_queue_size 4096 -hwaccel cuda -hwaccel_output_format nv12 -i $INPUT3 \
	${INPUT_RECONNECT4} -thread_queue_size 4096 -hwaccel cuda -hwaccel_output_format nv12 -i $INPUT4 \
	${INPUT_RECONNECT5} -thread_queue_size 4096 -hwaccel cuda -hwaccel_output_format nv12 -i $INPUT5 \
	${INPUT_RECONNECT6} -thread_queue_size 4096 -hwaccel cuda -hwaccel_output_format nv12 -i $INPUT6 \
	-filter_complex " \
		[0:v]format=nv12,hwupload_cuda,scale_cuda=-2:1080:format=nv12[base]; \
		[1:v]format=nv12,hwupload_cuda,scale_cuda=-2:720:format=nv12,fps=24,setpts=PTS-STARTPTS[upperright]; \
		[2:v]format=nv12,hwupload_cuda,scale_cuda=-2:360:format=nv12,fps=24,setpts=PTS-STARTPTS[upperleft]; \
		[3:v]format=nv12,hwupload_cuda,scale_cuda=-2:360:format=nv12,fps=24,setpts=PTS-STARTPTS[middleleft]; \
		[4:v]format=nv12,hwupload_cuda,scale_cuda=-2:360:format=nv12,fps=24,setpts=PTS-STARTPTS[lowerleft]; \
		[5:v]format=nv12,hwupload_cuda,scale_cuda=-2:360:format=nv12,fps=24,setpts=PTS-STARTPTS[lowermiddle]; \
		[6:v]format=nv12,hwupload_cuda,scale_cuda=-2:360:format=nv12,fps=24,setpts=PTS-STARTPTS[lowerright]; \
		[base][upperright]overlay_cuda=shortest=0:x=640:y=0 [l1]; \
		[l1][upperleft]overlay_cuda=shortest=0:x=0:y=0 [l2]; \
		[l2][middleleft]overlay_cuda=shortest=0:x=0:y=360 [l3]; \
		[l3][lowerleft]overlay_cuda=shortest=0:x=0:y=720 [l4]; \
		[l4][lowermiddle]overlay_cuda=shortest=0:x=640:y=720 [l5]; \
		[l5][lowerright]overlay_cuda=shortest=0:x=1280:y=720 [final] \
		" \
	-map "[final]" -c:v h264_nvenc -preset fast -tune ull -zerolatency 1 -b:v ${BITRATE} \
    -map 1:a:1\? -map 2:a:2\? -map 3:a:3\? -map 4:a:4\? -map 5:a:5\? -map 6:a:6\? \
	-f ${CONTAINER} ${OUTPUT}
